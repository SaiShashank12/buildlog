{% extends "base.html" %}

{% block content %}
<!-- EasyMDE CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
<style>
    /* Dark mode support for EasyMDE */
    .dark .EasyMDEContainer {
        background-color: rgb(31 41 55);
        color: rgb(229 231 235);
    }
    .dark .EasyMDEContainer .CodeMirror {
        background-color: rgb(31 41 55);
        color: rgb(229 231 235);
        border: 1px solid rgb(55 65 81);
    }
    .dark .editor-toolbar {
        background-color: rgb(31 41 55);
        border-top: 1px solid rgb(55 65 81);
        border-left: 1px solid rgb(55 65 81);
        border-right: 1px solid rgb(55 65 81);
    }
    .dark .editor-toolbar button {
        color: rgb(209 213 219) !important;
    }
    .dark .editor-toolbar button:hover {
        background-color: rgb(55 65 81);
        border-color: rgb(75 85 99);
    }
    .dark .editor-toolbar.active {
        background-color: rgb(55 65 81);
    }
    .dark .editor-toolbar i.separator {
        border-left: 1px solid rgb(75 85 99);
        border-right: 1px solid rgb(55 65 81);
    }
    .dark .CodeMirror-cursor {
        border-left: 1px solid rgb(229 231 235);
    }
    .dark .cm-header {
        color: rgb(147 197 253);
    }
    .dark .cm-strong {
        color: rgb(253 186 116);
    }
    .dark .cm-em {
        color: rgb(167 243 208);
    }
    .dark .cm-link {
        color: rgb(196 181 253);
    }
    .dark .cm-url {
        color: rgb(196 181 253);
    }
    /* Ensure editor fits properly */
    .EasyMDEContainer {
        border-radius: 0.5rem;
    }
    .EasyMDEContainer .CodeMirror {
        min-height: 300px;
        border-bottom-left-radius: 0.5rem;
        border-bottom-right-radius: 0.5rem;
    }
    .editor-toolbar {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
</style>
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 border border-transparent dark:border-gray-700 transition-colors">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
            {% if log %}Edit Log Entry{% else %}New Log Entry{% endif %}
        </h1>
        <p class="text-gray-600 dark:text-gray-300 mb-6">{{ project.name }}</p>

        <form method="POST" action="{% if log %}/projects/{{ project['$id'] }}/logs/{{ log['$id'] }}/edit{% else %}/projects/{{ project['$id'] }}/logs/new{% endif %}" class="space-y-6">
            <!-- Log Type -->
            <div>
                <label for="log_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Log Type
                </label>
                <select
                    id="log_type"
                    name="log_type"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                >
                    <option value="update" {% if log and log.log_type == 'update' %}selected{% endif %}>Update</option>
                    <option value="milestone" {% if log and log.log_type == 'milestone' %}selected{% endif %}>Milestone</option>
                    <option value="feature" {% if log and log.log_type == 'feature' %}selected{% endif %}>Feature</option>
                    <option value="bug_fix" {% if log and log.log_type == 'bug_fix' %}selected{% endif %}>Bug Fix</option>
                    <option value="note" {% if log and log.log_type == 'note' %}selected{% endif %}>Note</option>
                </select>
            </div>

            <!-- Title -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Title <span class="text-red-500">*</span>
                </label>
                <input
                    type="text"
                    id="title"
                    name="title"
                    value="{{ log.title if log else '' }}"
                    required
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    placeholder="What did you work on today?"
                >
            </div>

            <!-- Content -->
            <div>
                <label for="content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Content <span class="text-red-500">*</span>
                </label>
                <textarea
                    id="content"
                    name="content"
                    rows="10"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent font-mono text-sm"
                    placeholder="Describe your progress, challenges, and achievements..."
                >{{ log.content if log else '' }}</textarea>
                <div class="mt-2 flex items-center gap-2">
                    <button
                        type="button"
                        id="generateContentBtn"
                        class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-purple-600 hover:to-indigo-700 transition"
                    >
                        <i class="fas fa-magic mr-2"></i>Generate with AI
                    </button>
                    <span id="contentLoader" class="text-sm text-gray-500 hidden">
                        <i class="fas fa-spinner fa-spin mr-1"></i>Generating...
                    </span>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use the toolbar buttons or type markdown directly. Full preview available!</p>
            </div>

            <!-- Tags -->
            <div>
                <label for="tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Tags
                </label>
                <input
                    type="text"
                    id="tags"
                    name="tags"
                    value="{{ log.tags|join(', ') if log and log.tags else '' }}"
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                    placeholder="frontend, api, testing (comma-separated)"
                >
                <div class="mt-2 flex items-center gap-2">
                    <button
                        type="button"
                        id="suggestTagsBtn"
                        class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-purple-600 hover:to-indigo-700 transition"
                    >
                        <i class="fas fa-tags mr-2"></i>Suggest Tags with AI
                    </button>
                    <span id="tagsLoader" class="text-sm text-gray-500 hidden">
                        <i class="fas fa-spinner fa-spin mr-1"></i>Generating...
                    </span>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Separate multiple tags with commas</p>
            </div>

            <!-- Buttons -->
            <div class="flex gap-4 pt-4">
                <button
                    type="submit"
                    class="flex-1 bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
                >
                    <i class="fas fa-save mr-2"></i>
                    {% if log %}Update Log Entry{% else %}Add Log Entry{% endif %}
                </button>
                <a
                    href="/projects/{{ project['$id'] }}"
                    class="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition text-center"
                >
                    <i class="fas fa-times mr-2"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- EasyMDE JS -->
<script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
<script>
// Initialize EasyMDE
let easyMDE;
document.addEventListener('DOMContentLoaded', function() {
    easyMDE = new EasyMDE({
        element: document.getElementById('content'),
        spellChecker: false,
        autofocus: false,
        placeholder: 'Describe your progress, challenges, and achievements...',
        toolbar: [
            'bold', 'italic', 'heading', '|',
            'quote', 'unordered-list', 'ordered-list', '|',
            'link', 'code', 'table', '|',
            'preview', 'side-by-side', 'fullscreen', '|',
            'guide'
        ],
        status: ['lines', 'words', 'cursor'],
        renderingConfig: {
            singleLineBreaks: false,
            codeSyntaxHighlighting: true,
        },
        minHeight: '300px',
    });

    // Add form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const content = easyMDE.value().trim();
        if (!content) {
            e.preventDefault();
            alert('Please enter some content for the log entry.');
            easyMDE.codemirror.focus();
            return false;
        }
    });
});

document.getElementById('generateContentBtn').addEventListener('click', async function() {
    const projectName = "{{ project.name }}";
    const logType = document.getElementById('log_type').value;
    const title = document.getElementById('title').value;

    const btn = this;
    const loader = document.getElementById('contentLoader');
    const contentField = document.getElementById('content');

    // Show loading state
    btn.disabled = true;
    loader.classList.remove('hidden');

    try {
        const formData = new FormData();
        formData.append('project_name', projectName);
        formData.append('log_type', logType);
        formData.append('context', title || '');

        const response = await fetch('/ai/generate-log-content', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Set content in EasyMDE editor
            if (easyMDE) {
                easyMDE.value(data.content);
            } else {
                contentField.value = data.content;
            }
        } else {
            alert(data.error || 'Failed to generate content');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to generate content. Please try again.');
    } finally {
        btn.disabled = false;
        loader.classList.add('hidden');
    }
});

document.getElementById('suggestTagsBtn').addEventListener('click', async function() {
    const title = document.getElementById('title').value;
    // Get content from EasyMDE editor
    const content = easyMDE ? easyMDE.value() : document.getElementById('content').value;

    if (!title && !content) {
        alert('Please enter a title or content first to generate tag suggestions.');
        return;
    }

    const btn = this;
    const loader = document.getElementById('tagsLoader');
    const tagsField = document.getElementById('tags');

    // Show loading state
    btn.disabled = true;
    loader.classList.remove('hidden');

    try {
        const formData = new FormData();
        formData.append('title', title || '');
        formData.append('content', content || '');

        const response = await fetch('/ai/suggest-tags', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            tagsField.value = data.tags.join(', ');
        } else {
            alert(data.error || 'Failed to suggest tags');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to suggest tags. Please try again.');
    } finally {
        btn.disabled = false;
        loader.classList.add('hidden');
    }
});
</script>
{% endblock %}
