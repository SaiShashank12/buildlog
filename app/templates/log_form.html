{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow-md p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            {% if log %}Edit Log Entry{% else %}New Log Entry{% endif %}
        </h1>
        <p class="text-gray-600 mb-6">{{ project.name }}</p>

        <form method="POST" action="{% if log %}/projects/{{ project['$id'] }}/logs/{{ log['$id'] }}/edit{% else %}/projects/{{ project['$id'] }}/logs/new{% endif %}" class="space-y-6">
            <!-- Log Type -->
            <div>
                <label for="log_type" class="block text-sm font-medium text-gray-700 mb-2">
                    Log Type
                </label>
                <select
                    id="log_type"
                    name="log_type"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                >
                    <option value="update" {% if log and log.log_type == 'update' %}selected{% endif %}>Update</option>
                    <option value="milestone" {% if log and log.log_type == 'milestone' %}selected{% endif %}>Milestone</option>
                    <option value="feature" {% if log and log.log_type == 'feature' %}selected{% endif %}>Feature</option>
                    <option value="bug_fix" {% if log and log.log_type == 'bug_fix' %}selected{% endif %}>Bug Fix</option>
                    <option value="note" {% if log and log.log_type == 'note' %}selected{% endif %}>Note</option>
                </select>
            </div>

            <!-- Title -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                    Title <span class="text-red-500">*</span>
                </label>
                <input
                    type="text"
                    id="title"
                    name="title"
                    value="{{ log.title if log else '' }}"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="What did you work on today?"
                >
            </div>

            <!-- Content -->
            <div>
                <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                    Content <span class="text-red-500">*</span>
                </label>
                <textarea
                    id="content"
                    name="content"
                    rows="10"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent font-mono text-sm"
                    placeholder="Describe your progress, challenges, and achievements..."
                >{{ log.content if log else '' }}</textarea>
                <div class="mt-2 flex items-center gap-2">
                    <button
                        type="button"
                        id="generateContentBtn"
                        class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:from-purple-600 hover:to-indigo-700 transition"
                    >
                        <i class="fas fa-magic mr-2"></i>Generate with AI
                    </button>
                    <span id="contentLoader" class="text-sm text-gray-500 hidden">
                        <i class="fas fa-spinner fa-spin mr-1"></i>Generating...
                    </span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Supports markdown formatting</p>
            </div>

            <!-- Tags -->
            <div>
                <label for="tags" class="block text-sm font-medium text-gray-700 mb-2">
                    Tags
                </label>
                <input
                    type="text"
                    id="tags"
                    name="tags"
                    value="{{ log.tags|join(', ') if log and log.tags else '' }}"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="frontend, api, testing (comma-separated)"
                >
                <p class="text-xs text-gray-500 mt-1">Separate multiple tags with commas</p>
            </div>

            <!-- Buttons -->
            <div class="flex gap-4 pt-4">
                <button
                    type="submit"
                    class="flex-1 bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
                >
                    <i class="fas fa-save mr-2"></i>
                    {% if log %}Update Log Entry{% else %}Add Log Entry{% endif %}
                </button>
                <a
                    href="/projects/{{ project['$id'] }}"
                    class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition text-center"
                >
                    <i class="fas fa-times mr-2"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('generateContentBtn').addEventListener('click', async function() {
    const projectName = "{{ project.name }}";
    const logType = document.getElementById('log_type').value;
    const title = document.getElementById('title').value;

    const btn = this;
    const loader = document.getElementById('contentLoader');
    const contentField = document.getElementById('content');

    // Show loading state
    btn.disabled = true;
    loader.classList.remove('hidden');

    try {
        const formData = new FormData();
        formData.append('project_name', projectName);
        formData.append('log_type', logType);
        formData.append('context', title || '');

        const response = await fetch('/ai/generate-log-content', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            contentField.value = data.content;
        } else {
            alert(data.error || 'Failed to generate content');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to generate content. Please try again.');
    } finally {
        btn.disabled = false;
        loader.classList.add('hidden');
    }
});
</script>
{% endblock %}
