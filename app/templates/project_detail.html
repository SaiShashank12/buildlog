{% extends "base.html" %}

{% block content %}
<!-- Marked.js for markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<style>
    /* Dark mode styles for markdown content */
    .log-content h1, .log-content h2, .log-content h3,
    .log-content h4, .log-content h5, .log-content h6 {
        font-weight: 600;
        margin-top: 1em;
        margin-bottom: 0.5em;
    }

    .dark .log-content h1, .dark .log-content h2, .dark .log-content h3,
    .dark .log-content h4, .dark .log-content h5, .dark .log-content h6 {
        color: rgb(243 244 246);
    }

    .log-content h1 { font-size: 1.5em; }
    .log-content h2 { font-size: 1.3em; }
    .log-content h3 { font-size: 1.1em; }

    .log-content p {
        margin-bottom: 0.75em;
        color: rgb(75 85 99);
    }

    .dark .log-content p {
        color: rgb(209 213 219);
    }

    .log-content ul, .log-content ol {
        margin-left: 1.5em;
        margin-bottom: 0.75em;
    }

    .log-content li {
        margin-bottom: 0.25em;
        color: rgb(75 85 99);
    }

    .dark .log-content li {
        color: rgb(209 213 219);
    }

    .log-content strong {
        font-weight: 600;
        color: rgb(17 24 39);
    }

    .dark .log-content strong {
        color: rgb(243 244 246);
    }

    .log-content code {
        background-color: rgb(243 244 246);
        color: rgb(17 24 39);
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
    }

    .dark .log-content code {
        background-color: rgb(55 65 81);
        color: rgb(229 231 235);
    }

    .log-content pre {
        background-color: rgb(243 244 246);
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 0.75em;
    }

    .dark .log-content pre {
        background-color: rgb(31 41 55);
    }

    .log-content pre code {
        background-color: transparent;
        padding: 0;
    }

    .log-content a {
        color: rgb(99 102 241);
        text-decoration: underline;
    }

    .dark .log-content a {
        color: rgb(165 180 252);
    }

    .log-content blockquote {
        border-left: 4px solid rgb(209 213 219);
        padding-left: 1rem;
        margin: 1rem 0;
        color: rgb(107 114 128);
    }

    .dark .log-content blockquote {
        border-left-color: rgb(75 85 99);
        color: rgb(156 163 175);
    }
</style>
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Project Header -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-transparent dark:border-gray-700 transition-colors">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{{ project.name }}</h1>
                <p class="text-gray-600 dark:text-gray-300">{{ project.description or 'No description provided' }}</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <a href="/projects/{{ project['$id'] }}/edit" class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition shadow-sm" title="Edit project details">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <button id="generateSummaryBtn" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition shadow-md" title="Generate AI-powered quick overview of your project">
                    <i class="fas fa-magic"></i> AI Summary
                </button>
                <button id="generateReadmeBtn" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-indigo-700 transition shadow-md" title="Generate complete README.md for GitHub with copy to clipboard">
                    <i class="fas fa-file-alt"></i> Generate README
                </button>
                <a href="/projects/{{ project['$id'] }}/export" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-md" title="Download all logs as a single Markdown file">
                    <i class="fas fa-download"></i> Export to Markdown
                </a>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-6">
            {% if project.tech_stack %}
            <div>
                <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Tech Stack</h3>
                <div class="flex flex-wrap gap-2">
                    {% for tech in project.tech_stack %}
                    <span class="px-3 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-primary dark:text-indigo-300 rounded-full text-sm">{{ tech }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div>
                <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Links</h3>
                <div class="space-y-2">
                    {% if project.repository_url %}
                    <a href="{{ project.repository_url }}" target="_blank" class="text-primary dark:text-indigo-400 hover:underline block">
                        <i class="fab fa-github mr-1"></i> Repository
                    </a>
                    {% endif %}
                    {% if project.demo_url %}
                    <a href="{{ project.demo_url }}" target="_blank" class="text-primary dark:text-indigo-400 hover:underline block">
                        <i class="fas fa-external-link-alt mr-1"></i> Live Demo
                    </a>
                    {% endif %}
                    <a href="/portfolio/{{ project['$id'] }}" target="_blank" class="text-primary dark:text-indigo-400 hover:underline block">
                        <i class="fas fa-globe mr-1"></i> Public Portfolio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Build Logs Section -->
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Build Log Timeline</h2>
        <a href="/projects/{{ project['$id'] }}/logs/new" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-plus mr-2"></i> Add Log Entry
        </a>
    </div>

    {% if build_logs %}
    <!-- Timeline -->
    <div class="relative">
        <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-200 dark:bg-gray-700"></div>

        <div class="space-y-6">
            {% for log in build_logs %}
            <div class="relative pl-16">
                <div class="absolute left-6 w-4 h-4 rounded-full bg-primary border-4 border-white dark:border-gray-900"></div>

                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hover:shadow-lg transition border border-transparent dark:border-gray-700">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full
                                {% if log.log_type == 'milestone' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
                                {% elif log.log_type == 'feature' %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300
                                {% elif log.log_type == 'bug_fix' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300
                                {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                                {{ log.log_type|replace('_', ' ')|title }}
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <a href="/projects/{{ project['$id'] }}/logs/{{ log['$id'] }}/edit" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="POST" action="/projects/{{ project['$id'] }}/logs/{{ log['$id'] }}/delete" class="inline" onsubmit="return confirm('Are you sure you want to delete this log entry?');">
                                <button type="submit" class="text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">{{ log.title }}</h3>
                    <div class="mb-4 log-content">{{ log.content }}</div>

                    {% if log.tags %}
                    <div class="flex flex-wrap gap-2 mb-4">
                        {% for tag in log.tags %}
                        <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs rounded">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-clock mr-1"></i>
                        {{ log.created_at[:16].replace('T', ' ') if log.created_at else 'N/A' }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-12 text-center border border-transparent dark:border-gray-700">
        <i class="fas fa-book-open text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
        <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-2">No Build Logs Yet</h3>
        <p class="text-gray-600 dark:text-gray-300 mb-6">Start documenting your progress by adding your first log entry!</p>
        <a href="/projects/{{ project['$id'] }}/logs/new" class="bg-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition inline-block">
            <i class="fas fa-plus mr-2"></i> Add First Log Entry
        </a>
    </div>
    {% endif %}
</div>

<script>
// AI Summary Modal
const summaryModal = document.createElement('div');
summaryModal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
summaryModal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">AI Project Summary</h2>
                <button id="closeSummaryModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="summaryContent" class="prose dark:prose-invert max-w-none">
                <div class="flex items-center justify-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
                </div>
            </div>
        </div>
    </div>
`;
document.body.appendChild(summaryModal);

// README Modal
const readmeModal = document.createElement('div');
readmeModal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
readmeModal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Generated README</h2>
                <button id="closeReadmeModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="readmeContent" class="prose dark:prose-invert max-w-none">
                <div class="flex items-center justify-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button id="copyReadmeBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                    <i class="fas fa-copy mr-2"></i>Copy to Clipboard
                </button>
            </div>
        </div>
    </div>
`;
document.body.appendChild(readmeModal);

// Generate Summary Button
document.getElementById('generateSummaryBtn').addEventListener('click', async function() {
    const projectId = "{{ project['$id'] }}";

    summaryModal.classList.remove('hidden');
    document.getElementById('summaryContent').innerHTML = `
        <div class="flex items-center justify-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
        </div>
    `;

    try {
        const formData = new FormData();
        formData.append('project_id', projectId);

        const response = await fetch('/ai/generate-summary', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Convert markdown to HTML-like display
            let summaryHtml = data.summary
                .replace(/^### (.*)$/gm, '<h3 class="text-lg font-semibold text-gray-900 dark:text-white mt-3 mb-2">$1</h3>')
                .replace(/^## (.*)$/gm, '<h2 class="text-xl font-bold text-gray-900 dark:text-white mt-4 mb-2">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-gray-900 dark:text-white">$1</strong>')
                .replace(/^- (.*)$/gm, '<li class="ml-4 text-gray-700 dark:text-gray-300">$1</li>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');

            document.getElementById('summaryContent').innerHTML = summaryHtml;
        } else {
            document.getElementById('summaryContent').innerHTML = `
                <div class="text-red-600 dark:text-red-400">
                    <i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Failed to generate summary'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('summaryContent').innerHTML = `
            <div class="text-red-600 dark:text-red-400">
                <i class="fas fa-exclamation-circle mr-2"></i>Failed to generate summary. Please try again.
            </div>
        `;
    }
});

// Generate README Button
document.getElementById('generateReadmeBtn').addEventListener('click', async function() {
    const projectId = "{{ project['$id'] }}";

    readmeModal.classList.remove('hidden');
    document.getElementById('readmeContent').innerHTML = `
        <div class="flex items-center justify-center py-8">
            <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
        </div>
    `;

    try {
        const formData = new FormData();
        formData.append('project_id', projectId);

        const response = await fetch('/ai/generate-readme', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Store raw markdown for copying
            window.generatedReadme = data.readme;

            // Convert markdown to HTML-like display
            let readmeHtml = data.readme
                .replace(/^### (.*)$/gm, '<h3 class="text-xl font-semibold text-gray-900 dark:text-white mt-4 mb-2">$1</h3>')
                .replace(/^## (.*)$/gm, '<h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-5 mb-2">$1</h2>')
                .replace(/^# (.*)$/gm, '<h1 class="text-3xl font-bold text-gray-900 dark:text-white mt-6 mb-3">$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-gray-900 dark:text-white">$1</strong>')
                .replace(/`([^`]+)`/g, '<code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-sm text-gray-800 dark:text-gray-200">$1</code>')
                .replace(/^- (.*)$/gm, '<li class="ml-4 text-gray-700 dark:text-gray-300">$1</li>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');

            document.getElementById('readmeContent').innerHTML = readmeHtml;
        } else {
            document.getElementById('readmeContent').innerHTML = `
                <div class="text-red-600 dark:text-red-400">
                    <i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Failed to generate README'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('readmeContent').innerHTML = `
            <div class="text-red-600 dark:text-red-400">
                <i class="fas fa-exclamation-circle mr-2"></i>Failed to generate README. Please try again.
            </div>
        `;
    }
});

// Close modal handlers
document.getElementById('closeSummaryModal').addEventListener('click', function() {
    summaryModal.classList.add('hidden');
});

document.getElementById('closeReadmeModal').addEventListener('click', function() {
    readmeModal.classList.add('hidden');
});

// Copy README to clipboard
document.getElementById('copyReadmeBtn').addEventListener('click', function() {
    if (window.generatedReadme) {
        navigator.clipboard.writeText(window.generatedReadme).then(() => {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        });
    }
});

// Close modals on background click
summaryModal.addEventListener('click', function(e) {
    if (e.target === summaryModal) {
        summaryModal.classList.add('hidden');
    }
});

readmeModal.addEventListener('click', function(e) {
    if (e.target === readmeModal) {
        readmeModal.classList.add('hidden');
    }
});

// Render markdown in log content
document.addEventListener('DOMContentLoaded', function() {
    const logContents = document.querySelectorAll('.log-content');
    logContents.forEach(function(element) {
        const markdownText = element.textContent;
        element.innerHTML = marked.parse(markdownText);
    });
});
</script>

{% endblock %}
